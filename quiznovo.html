<script>
  let allQuestions = [];
  let selectedQuestions = [];
  const teams = {1: [], 2: []};
  const usedMembers = {1: [], 2: []};
  const scores = {1: 0, 2: 0};
  let currentQuestion = 0;
  let currentTeam = 1;

  document.getElementById('saveQuestionsBtn').addEventListener('click', saveQuestions);
  document.getElementById('saveTeam1Btn').addEventListener('click', () => saveTeam(1));
  document.getElementById('saveTeam2Btn').addEventListener('click', () => saveTeam(2));
  document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
  document.getElementById('correctBtn').addEventListener('click', () => answer(true));
  document.getElementById('wrongBtn').addEventListener('click', () => answer(false));

  function saveQuestions() {
    const input = document.getElementById('questionsInput').value.trim().split('\n');
    if (input.length > 40) return alert('Máximo de 40 perguntas permitido.');
    allQuestions = input.filter(q => q.trim());
    alert(`Perguntas salvas: ${allQuestions.length}`);
  }

  function saveTeam(teamNumber) {
    const input = document.getElementById(`team${teamNumber}Input`).value.trim().split('\n');
    if (input.length > 20) return alert(`Máximo de 20 nomes na equipe ${teamNumber}.`);
    teams[teamNumber] = input.filter(name => name.trim());
    alert(`Equipe ${teamNumber} cadastrada: ${teams[teamNumber].length} membros`);
  }

  function startQuiz() {
    if (allQuestions.length < 5) return alert('Você precisa de pelo menos 5 perguntas.');
    if (!teams[1].length || !teams[2].length) return alert('Cadastre pelo menos 1 membro em cada equipe.');

    selectedQuestions = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
    currentQuestion = 0;
    scores[1] = 0;
    scores[2] = 0;
    usedMembers[1] = [];
    usedMembers[2] = [];
    currentTeam = 1;

    document.getElementById('quiz').classList.remove('hidden');
    document.getElementById('finalResult').classList.add('hidden');
    enableAnswerButtons(true);
    showQuestion();
  }

  function showQuestion() {
    if (currentQuestion >= selectedQuestions.length) return endQuiz();

    const questionText = selectedQuestions[currentQuestion];
    document.getElementById('question').innerText = questionText;
    document.getElementById('questionIndex').innerText = currentQuestion + 1;
    document.getElementById('score1').innerText = scores[1];
    document.getElementById('score2').innerText = scores[2];

    const members = teams[currentTeam];
    const used = usedMembers[currentTeam];
    const available = members.filter(name => !used.includes(name));

    if (available.length === 0) {
      // Reset para permitir todos novamente, sem repetir até usar todos.
      usedMembers[currentTeam] = [];
      return showQuestion(); // Tenta de novo
    }

    const randomIndex = Math.floor(Math.random() * available.length);
    const chosen = available[randomIndex];
    usedMembers[currentTeam].push(chosen);

    document.getElementById('currentTeam').innerText = `${chosen} (Equipe ${currentTeam})`;
  }

  function answer(correct) {
    if (correct) scores[currentTeam]++;
    
    currentTeam = currentTeam === 1 ? 2 : 1;

    // Quando ambos já responderam, avança pergunta
    if (currentTeam === 1) {
      currentQuestion++;
    }

    if (currentQuestion >= selectedQuestions.length) return endQuiz();

    showQuestion();
  }

  function endQuiz() {
    document.getElementById('quiz').classList.add('hidden');
    enableAnswerButtons(false);

    const result = scores[1] > scores[2]
      ? 'Equipe 1 venceu!'
      : scores[2] > scores[1]
        ? 'Equipe 2 venceu!'
        : 'Empate!';

    document.getElementById('finalResult').innerText = `Placar final: ${scores[1]} x ${scores[2]} - ${result}`;
    document.getElementById('finalResult').classList.remove('hidden');
  }

  function enableAnswerButtons(enable) {
    document.getElementById('correctBtn').disabled = !enable;
    document.getElementById('wrongBtn').disabled = !enable;
  }
</script>
